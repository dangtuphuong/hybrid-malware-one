/* eslint-disable react-hooks/exhaustive-deps */
import { Grid2, Typography } from "@mui/material";
import { useParams } from "react-router-dom";
// import DetectionResults from "./DetectionResults.jsx"; // Updated import
import BarChart from "./BarChart.jsx"; // Import the BarChart component
import MultiBarChart from "./MultiBarChart.jsx";
import MalwareDistChart from "./MalwareDistChart.jsx";
import PageLayout from "../components/PageLayout.jsx";
import DataService from "../services/data-service";
import Metadata from "./Metadata.jsx";
import { useEffect, useState, useMemo } from "react";

const ReportPage = () => {
  const { reportId } = useParams();
  const [loading, setLoading] = useState(false);
  const [report, setReport] = useState({});
  const [models, setModels] = useState({});

  useEffect(() => {
    setLoading(true);
    DataService.getReportById(reportId)
      .then((res) => {
        setReport(res?.data?.report ?? {});
        setModels(res?.data?.models ?? {});
      })
      .catch((err) => {
        console.log(err);
      })
      .finally(() => setLoading(false));
  }, []);

  const k = Object.keys(models)?.length;

  const recallData = useMemo(
    () =>
      Object.entries(models).reduce((result, [modelName, modelDetails]) => {
        result[modelName] = modelDetails?.recall;
        return result;
      }, {}),
    [k]
  );

  const accuracyData = useMemo(
    () =>
      Object.entries(models).reduce((result, [modelName, modelDetails]) => {
        result[modelName] = modelDetails?.accuracy;
        return result;
      }, {}),
    [k]
  );

  const f1Data = useMemo(
    () =>
      Object.entries(models).reduce((result, [modelName, modelDetails]) => {
        result[modelName] = modelDetails?.f1;
        return result;
      }, {}),
    [k]
  );

  const precisionData = useMemo(
    () =>
      Object.entries(models).reduce((result, [modelName, modelDetails]) => {
        result[modelName] = modelDetails.precision;
        return result;
      }, {}),
    [k]
  );

  const classificationData = useMemo(
    () =>
      Object.entries(models).reduce((result, [modelName, modelDetails]) => {
        result[modelName] = modelDetails.classification_report;
        return result;
      }, {}),
    [k]
  );

  const distData = useMemo(
    () =>
      Object.entries(report?.malware_distribution || {}).reduce(
        (result, [modelName, modelValue]) => [
          ...result,
          { id: modelName, label: modelName, value: modelValue },
        ],
        []
      ),
    [k]
  );

  return (
    <PageLayout>
      <Typography variant="h5" sx={{ mb: 4, fontWeight: 600 }}>
        Analytical Report
      </Typography>
      <Grid2 container spacing={2}>
        <Grid2 size={6}>
          <Metadata report={report} />
        </Grid2>
        <Grid2 size={6}>
          <MalwareDistChart loading={loading} data={distData} />
        </Grid2>
        <Grid2 size={6}>
          <BarChart loading={loading} label="Accuracy" data={accuracyData} />
        </Grid2>
        <Grid2 size={6}>
          <BarChart loading={loading} label="Precision" data={precisionData} />
        </Grid2>
        <Grid2 size={6}>
          <BarChart loading={loading} label="Recall" data={recallData} />
        </Grid2>
        <Grid2 size={6}>
          <BarChart loading={loading} label="F1 Score" data={f1Data} />
        </Grid2>

        <Grid2 size={12}>
          <MultiBarChart
            loading={loading}
            label="Classification Report (Precision)"
            data={classificationData}
          />
        </Grid2>
      </Grid2>
    </PageLayout>
  );
};

export default ReportPage;
